<?php
session_start();

// Redirect if not logged in or not a resident
if (!isset($_SESSION['user_id']) || $_SESSION['role'] != 'Resident') {
    header("Location: ../login/login.php");
    exit();
}

// Database connection
$host = 'localhost';
$dbname = 'facilityreservationsystem';
$username = 'root';
$password = '';

try {
    $conn = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8mb4", $username, $password);
    $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch(PDOException $e) {
    die("Connection failed: " . $e->getMessage());
}

// Fetch current user data
$user_id = $_SESSION['user_id'];
$stmt = $conn->prepare("SELECT FirstName, LastName, Email, Birthday, Block, Lot, StreetName, ProfilePictureURL FROM users WHERE user_id = ?");
$stmt->execute([$user_id]);
$user = $stmt->fetch(PDO::FETCH_ASSOC);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Material Icons -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- Sidebar / Layout Styles -->
    <link rel="stylesheet" href="my-account.css">
    <link rel="stylesheet" href="side-navigation.css">

    <title>My Account</title>
</head>
<body>

<div class="app-layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <header class="sidebar-header">
            <img src="../asset/logo.png" alt="Header Logo" class="header-logo">
            <button class="sidebar-toggle">
                <span class="material-symbols-outlined">chevron_left</span>
            </button>
        </header>

        <div class="sidebar-content">
            <ul class="menu-list">
                <li class="menu-item"><a href="../home/home.php" class="menu-link"><img src="../asset/home.png" class="menu-icon">Home</a></li>
                <li class="menu-item"><a href="../resident-side/make-reservation.php" class="menu-link"><img src="../asset/makeareservation.png" class="menu-icon">Make a Reservation</a></li>
                <li class="menu-item"><a href="../resident-side/myreservations.php" class="menu-link"><img src="../asset/reservations.png" class="menu-icon">My Reservations</a></li>
                <li class="menu-item"><a href="#" class="menu-link active"><img src="../asset/profile.png" class="menu-icon">My Account</a></li>
            </ul>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="reservation-card p-4">

            <div class="page-header mb-3">My Account</div>

            <div class="row g-4">

                <!-- LEFT: PROFILE PICTURE -->
                <div class="col-md-4 text-center">

                    <img src="<?php echo $user['ProfilePictureURL'] ?: '../asset/default-profile.png'; ?>"
                         class="rounded-circle img-thumbnail mb-3"
                         style="width: 180px; height: 180px; object-fit: cover;">

                    <!-- Profile Picture Upload Form -->
                    <form action="update_profile_picture.php" method="POST" enctype="multipart/form-data">
                        <input type="file" name="profile_pic" id="profilePicInput" accept="image/*" hidden>

                        <button type="button" class="btn btn-primary w-100 mb-2"
                                onclick="document.getElementById('profilePicInput').click();">
                            Upload New Profile Picture
                        </button>

                        <button type="submit" class="btn btn-success w-100">Save Profile Picture</button>
                    </form>
                </div>

                <!-- RIGHT: PERSONAL INFO + PASSWORD -->
                <div class="col-md-8">

                    <!-- Success/Error Messages -->
                    <?php if (isset($_SESSION['error_message'])): ?>
                        <div class="alert alert-danger"><?php echo $_SESSION['error_message']; unset($_SESSION['error_message']); ?></div>
                    <?php endif; ?>

                    <?php if (isset($_SESSION['success_message'])): ?>
                        <div class="alert alert-success"><?php echo $_SESSION['success_message']; unset($_SESSION['success_message']); ?></div>
                    <?php endif; ?>

                    <!-- PERSONAL INFORMATION -->
                    <div class="card p-3 mb-4">
                        <h5 class="mb-3">Personal Information</h5>

                        <p><strong>Name:</strong> <?php echo $user['FirstName'] . " " . $user['LastName']; ?></p>
                        <p><strong>Email:</strong> <?php echo $user['Email']; ?></p>
                        <p><strong>Birthday:</strong> <?php echo $user['Birthday']; ?></p>
                        <p><strong>Address:</strong>
                            <?php echo "Block " . $user['Block'] . ", Lot " . $user['Lot'] . ", " . $user['StreetName']; ?>
                        </p>
                    </div>

                    <!-- CHANGE PASSWORD -->
                    <div class="card p-3">
                        <h5 class="mb-3">Change Password</h5>

                        <form action="update_password.php" method="POST">
                            <div class="mb-3">
                                <label class="form-label">Old Password</label>
                                <input type="password" name="old_password" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">New Password</label>
                                <input type="password" name="new_password" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" name="confirm_password" class="form-control" required>
                            </div>

                            <button type="submit" class="btn btn-warning w-100">Update Password</button>
                        </form>
                    </div>

                </div>

            </div>

        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="../resident-side/javascript/sidebar.js"></script>
</body>
</html>
